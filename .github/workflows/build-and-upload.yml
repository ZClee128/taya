name: Build and Upload to App Store

on:
  workflow_dispatch:
    inputs:
      upload_to_appstore:
        description: '是否上传到App Store Connect'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    name: Build iOS App
    uses: ./.github/workflows/reusable-ios-build.yml
    with:
      project_name: "taya.xcodeproj"
      scheme_name: "taya"
      bundle_id: "com.taya.com"
      provisioning_profile_name: "taya"
      configuration: "Release"
      xcode_version: "latest-stable"
      upload_to_appstore: ${{ github.event.inputs.upload_to_appstore == 'true' }}
      obfuscation_script_path: "scripts/advanced_obfuscate.py"
    secrets:
      BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
      P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      TEAM_ID: ${{ secrets.TEAM_ID }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
